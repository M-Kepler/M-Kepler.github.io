- [CPA 理论](#cpa-理论)
  - [举例说明 CAP 理论](#举例说明-cap-理论)
- [BASE 理论](#base-理论)
- [TCC 补偿事务](#tcc-补偿事务)
- [柔性事务与刚性事务](#柔性事务与刚性事务)
- [二阶段提交协议](#二阶段提交协议)

> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [www.cnblogs.com](https://www.cnblogs.com/ming-blogs/p/10664495.html)

# CPA 理论

由于对系统或者数据进行了拆分，我们的系统不再是单机系统，而是分布式系统，针对分布式系统的 CAP 原理包含如下三个元素。

![alt](https://img2018.cnblogs.com/blog/1555009/201904/1555009-20190407102241392-291144209.png)

CAP 原理指的是，这三个要素最多只能同时实现两点，不可能三者兼顾。因此在进行分布式架构设计时，必须做出取舍。而对于分布式数据系统，分区容忍性是基本要求，否则就失去了价值。因此设计分布式数据系统，就是在一致性和可用性之间取一个平衡。对于大多数 web 应用，其实并不需要强一致性，因此牺牲一致性而换取高可用性，是目前多数分布式数据库产品的方向。 当然，牺牲一致性，并不是完全不管数据的一致性，否则数据是混乱的，那么系统可用性再高分布式再好也没有了价值。牺牲一致性，只是不再要求关系型数据库中的强一致性，而是只要系统能达到最终一致性即可，考虑到客户体验，这个最终一致的时间窗口，要尽可能的对用户透明，也就是需要保障 “用户感知到的一致性”。通常是通过数据的多份异步复制来实现系统的高可用和数据的最终一致性的，“用户感知到的一致性” 的时间窗口则取决于数据复制到一致状态的时间。

- `C:Consistency, 一致性`

  在分布式系统中的所有数据 备份，在同一时刻具有同样的值，所有节点在同一时刻读取的数据都是最新的数据副本。

- `P: Partition tolerance, 分区容忍性`

  尽管网络上有部分消息丢失，但系统仍然可继续工作。

- `A:Availability, 可用性`

  好的响应性能。完全的可用性指的是在任何故障模型下，服务都会在有限的时间内处理完成并进行响应。

## 举例说明 CAP 理论

有 3 台机器，分别有 3 个数据库、有两张表，数据都是一样的

```log
Machine1  db1  tbl_person  tbl_order
Machine2  db2  tbl_person  tbl_order
Machine3  db3  tbl_person  tbl_order
```

- 当向 machine1 的 db1 的表 tbl_person、tbl_order 插入数数据时，同时要把插入的数据同步到 machine2、machine3，这就是 **`C 一致性`**

- 当其中的一台机器宕机了，可以继续对外提供服务，把宕机的机器重新启动起来可以继续服务，这就是 **`A 可用性`**

- 当 machine1 的机器坏了，数据全部丢失了，不会有任何问题，因为 machine2 和 machine3 上还有数据，重新加一台机器 machine4，把 machine2 和 machine3 其中一台机器的备份数据同步过来就可以了，这就是 **`P 分区容错性`**

# BASE 理论

是基于 CAP 定理演化而来，是对 CAP 中一致性和可用性权衡的结果。核心思想：即使无法做到强一致性，但每个业务根据自身的特点，采用适当的方式来使系统达到最终一致性。

**`Basically Avaliable` 基本可用**

> 在分布式系统出现故障时，允许损失部分可用性（服务降级、页面降级）。比如系统挂了，在页面上给个提示啥的

指分布式系统在出现故障的时候，允许损失部分可用性，保证核心可用。但不等价于不可用。比如：搜索引擎 0.5 秒返回查询结果，但由于故障，2 秒响应查询结果；网页访问过大时，部分用户提供降级服务，等。

**`Soft state` 软状态 / 柔性事务**

> 允许分布式系统出现中间状态。而且中间状态不影响系统的可用性。

软状态是指允许系统存在中间状态，并且该中间状态不会影响系统整体可用性。即允许系统在不同节点间副本同步的时候存在延时。

**`Eventual Consistency` 最终一致性**

> 数据复制 data replications 经过一段时间达到一致性。

系统中的所有数据副本经过一定时间后，最终能够达到一致的状态，不需要实时保证系统数据的强一致性。最终一致性是弱一致性的一种特殊情况。BASE 理论面向的是大型高可用可扩展的分布式系统，通过牺牲强一致性来获得可用性。ACID 是传统数据库常用的概念设计，追求强一致性模型。

![alt](https://img2018.cnblogs.com/blog/1555009/201904/1555009-20190407105105524-1408107369.png)

# TCC 补偿事务

# 柔性事务与刚性事务

> - 柔性事务满足 BASE 理论（基本可用，最终一致）
> - 刚性事务满足 ACID 理论 本文主要围绕分布式事务当中的柔性事务的处理方式进行讨论

- 柔性事务分为

  - 两阶段型

  - 补偿型

  - 异步确保型

  - 最大努力通知型几种。

# 二阶段提交协议

![alt](https://img2018.cnblogs.com/blog/1555009/201904/1555009-20190407110106700-1783489559.png)

- 第一阶段： 准备阶段：协调者向参与者发起指令，参与者评估自己的状态，如果参与者评估指令可以完成，则会写 redo 或者 undo 日志，让后锁定资源，执行操作，但并不提交。

- 第二阶段: 如果每个参与者明确返回准备成功，则协调者向参与者发送提交指令，参与者释放锁定的资源，如何任何一个参与者明确返回准备失败，则协调者会发送中指指令，参与者取消已经变更的事务，释放锁定的资源。

- 两阶段提交方案应用非常广泛，几乎所有商业 OLTP 数据库都支持 XA 协议。但是两阶段提交方案锁定资源时间长，对性能影响很大，基本不适合解决微服务事务问题。 缺点：如果协调者宕机，参与者没有协调者指挥，则会一直阻塞。

![alt](https://img2018.cnblogs.com/blog/1555009/201904/1555009-20190407113721007-1723212907.png)
