- [参考资料](#参考资料)
- [限流](#限流)
  - [为什么要限流](#为什么要限流)
  - [了解哪些限流方法](#了解哪些限流方法)
    - [计数器](#计数器)
    - [滑动窗口计数器](#滑动窗口计数器)
    - [漏桶限流](#漏桶限流)
    - [令牌桶限流](#令牌桶限流)
  - [分布式限流与单机限流](#分布式限流与单机限流)
- [其他](#其他)

# 参考资料

# 限流

- [★ 你对限流了解多少](https://mp.weixin.qq.com/s/XGHS3lRJKMJ52PSLZCfpAQ)

## 为什么要限流

保证系统的稳定性，预防 DDOS 攻击

## 了解哪些限流方法

- 简单的计数器

- 解决计数器中 `临界值` 问题，引入滑动窗口

- 解决 `流量激增` 问题，引入漏桶

- `更灵活` 地进行限流，引入令牌桶

### 计数器

就是一个简单的计数器，每来一个请求，计数器就加一，达到阈值之后就丢弃请求

- 这个算法比较简单粗暴，我们只需要一个累加变量，然后`每隔一秒钟去刷新这个累加变量，然后再判断这个累加变量是否大于我们的最大 QPS`

- **`没解决临界问题`**

  ![alt](https://mmbiz.qpic.cn/mmbiz_png/eSdk75TK4nFKiaAw8qibpoGwamBd68SM4IR9ibFUrZcg75rvEbH6jTDT1DVRHAicaUxzGOtuMj4lkjhbCydIlnZ2RA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=ii1)

  假设限流阀值为 5 个请求，单位时间窗口是 1s,如果我们在单位时间内的前 0.8-1s 和 1-1.2s，分别并发 5 个请求。虽然都没有超过阀值，但是如果算 0.8-1.2s,则并发数高达 10，已经超过单位时间 1s 不超过 5 阀值的定义啦。

### 滑动窗口计数器

可以解决计数器出现在的`临界问题`，其实就是窗口慢慢向前滑动，确保窗口内的请求数没有超过阈值，所以滑动速度越慢越精细；

滑动窗口限流解决固定窗口临界值的问题。它将单位时间周期分为 n 个小周期，分别记录每个小周期内接口的访问次数，并且根据时间滑动删除过期的小周期。

![alt](https://mmbiz.qpic.cn/mmbiz_png/eSdk75TK4nFKiaAw8qibpoGwamBd68SM4IQF0IpmqXduLVGMzozzRia3v97MOxNalzXxOqYE3bmw7AbiaA4zTso3Dw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

- 如果阈值是 5，滑动窗口的窗口大小是 0.2s，（每 0.2s 统计一次请求数，中请求数不超过 5s 的阈值）

- 0.8-1s 来了 5 个请求，然后 1-1.2s 又来了 5 个请求，窗口监控 1s 内的请求，而且 0.2s 向前滑动一次，那么 0.8-1.2s 在一次检测范围内，一共就有 10 个请求，超过阈值了

- **`没解决短时间之内【流量激增】的问题`**

### 漏桶限流

水经过漏斗流下来，可以达到匀速的效果，避免流量一下子全部进来，溢出的部分就丢弃；

不论流量有多大都会先到漏桶中，然后以均匀的速度流出，想让匀速为 `100qps`，那么我们可以得到每流出一个流量需要消耗 `10ms`，类似一个队列，每隔 `10ms` 从队列头部取出流量进行放行，而我们的队列也就是漏桶，当流量大于队列的长度的时候，我们就可以拒绝超出的部分

![alt](https://mmbiz.qpic.cn/mmbiz_png/eSdk75TK4nFKiaAw8qibpoGwamBd68SM4I88W4pK6ZDWia9YH8xJG2KqfQdV00awicl0mkKIwdlWv4lr4n3FELveHA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

- 请求来了放入桶里

- 桶装满了拒绝请求

- `服务定速` 从桶里拿请求进行处理

- 上面滑动窗口的突发流量处理问题，在漏桶算法这里就不管那么多了，请求全部丢进队列里，处理程序定速进行处理

- **`没有完美解决流量激增的问题，流量大的时候能不能处理快一点，【不匀速】`**

### 令牌桶限流

本来漏桶的流速是固定的，现在服务可以根据自身负载情况发放通行证，`更灵活地`进行限流；

就像公园放票一样，园区内成年人少就放多点票，儿童多也没关系可以继续放票；`可以根据属性来决定阈值`

![alt](https://mmbiz.qpic.cn/mmbiz_png/eSdk75TK4nFKiaAw8qibpoGwamBd68SM4ItcyV67dKNA8KDPRhg4hLjKJkpicQw4ibPDS9UzrRoXV12uCWibNBloeBA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

- 定速往桶里放入令牌

- 令牌数量超过桶的限制就丢弃

- 请求来了，向着桶里索要令牌，拿到令牌才处理，否则拒绝

- 在流量激增的时候，令牌很快就会被取走，而不像之前那样匀速处理

## 分布式限流与单机限流

- 限流算法还是一样的，只是算法中的数据，比如阈值怎么在分布式节点上共享的问题

  直接上 Redis

# 其他
