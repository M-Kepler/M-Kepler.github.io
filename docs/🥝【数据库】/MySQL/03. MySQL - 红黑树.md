- [红黑树](#红黑树)
  - [`2-3` 树](#2-3-树)
    - [节点插入](#节点插入)
    - [节点删除](#节点删除)
  - [红黑树](#红黑树-1)
    - [为什么红黑树是红色或黑色的](#为什么红黑树是红色或黑色的)
    - [★ 红黑树和 B+ 树的区别](#-红黑树和-b-树的区别)
    - [`2-3` 树与红黑树的区别](#2-3-树与红黑树的区别)
    - [红黑有什么特点](#红黑有什么特点)
    - [红黑树和 AVL 树的区别](#红黑树和-avl-树的区别)
    - [红黑树是怎么实现减少旋转就能达到平衡的](#红黑树是怎么实现减少旋转就能达到平衡的)
  - [B 树（多路平衡搜索树）](#b-树多路平衡搜索树)
  - [B+ 树](#b-树)
    - [为什么 B+ 树要把数据存放在叶子节点](#为什么-b-树要把数据存放在叶子节点)
    - [★ B 树和 B+ 树的优缺点](#-b-树和-b-树的优缺点)
    - [★ 为什么使用 `B+` 树而不是 `B` 树](#-为什么使用-b-树而不是-b-树)
    - [哈希索引和 `B+` 树索引有什么区别](#哈希索引和-b-树索引有什么区别)
- [参考资料](#参考资料)

# 红黑树

**二叉查找树**

根节点大于左子节点，小于右子节点

![alt](https://mmbiz.qpic.cn/mmbiz_gif/MOwlO0INfQoLqmAK6QYdbdUlbu7OszlxLknn31rrfkmYd5z2HRsBXKcnkTPAIKReichnjMvNY7JvWsY9dmhSJVw/640?wx_fmt=gif)

**平衡二叉树**

任意节点的子树的高度差都小于等于 1

**AVL 平衡二叉查找树**

![alt](https://mmbiz.qpic.cn/mmbiz_gif/MOwlO0INfQoLqmAK6QYdbdUlbu7Oszlx8MhyPJVJsUfVuhNqapib2elQFOrf7PkCuo8p6kAbqelfaQQaIhf7EyA/640?wx_fmt=gif)

## `2-3` 树

`2-3` 树是二叉查找树的变种，是`满足二叉查找树的性质`的；`n-` 节点意思是，这个节点可以有 n 个子节点

- `2-` 节点即普通节点：包含一个元素，两条子链接

  ![alt](https://img-blog.csdn.net/20160902172253515?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center)

- `3-` 节点则是扩充版，包含 2 个元素和三条链接

  两个元素 A、B，左边的链接指向小于 A 的节点，中间的链接指向介于 A、B 值之间的节点，右边的链接指向大于 B 的节点。

  ![alt](https://img-blog.csdn.net/20160902172607298?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center)

- 由 `2-`、或 `3-` 节点构成的树叫做 `2-3` 树

  ![alt](https://mmbiz.qpic.cn/mmbiz_png/MOwlO0INfQoLqmAK6QYdbdUlbu7OszlxUDf0WN4pM9OBmtSp0cxbxxSrTWGia2TqywywTkvX8NIYdibHaE3Vp9ibA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

### 节点插入

按照二叉查找树的插入删除方式，只要最终节点还是 `2-` 或 `3-` 节点，那就没问题，否则要进行调整

- 向 `2-` 节点中插入元素

  ![alt](https://mmbiz.qpic.cn/mmbiz_png/y8sSEKN82JnFovFs2LS21LuLpaIOfBNpupQ7icIzeEd1UUyKWYUjXXoStwRoSmQqk3Sdk2lACXwAFiad9YicE65Zg/640?tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

- 向只含有一个 `3-` 节点的树中插入元素

  ![alt](https://mmbiz.qpic.cn/mmbiz_png/y8sSEKN82JnFovFs2LS21LuLpaIOfBNpM59qsMGrkZRkUynxHgpIn3Fo2piarCc4iccRD6kG5AlT9bynKzice2lKg/640?tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

  插入元素后，都可以通过节点调整，来保持 `3-` 树的特性，且平衡的状态

- 向一个父节点为 `3-` 节点的 `3-` 节点中插入元素

  ![alt](https://mmbiz.qpic.cn/mmbiz_png/y8sSEKN82JnFovFs2LS21LuLpaIOfBNp6QPUGN1xXwMTPcib7DiaeF9GZgRqJtuz3xMHkSyg0nKjvd3vicnia1HryA/640?tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

### 节点删除

## 红黑树

> 二叉平衡树

### 为什么红黑树是红色或黑色的

> 把 n- 树优化成了二叉树（所以树会更高）

- 红黑树中，所有的节点都是标准的 `2-` 节点，为了体现出 `3-` 节点，这里将 `3-` 节点的两个元素用 ==**`左斜红色的链接`**== 连接起来，即连接了两个 `2-` 节点来表示一个 `3-` 节点

- 红链接所指向的节点标记为红色节点，黑色标记的节点就是普通的节点

  所以才会有那样一条定义，叫 `【从任一节点到其每个叶子的所有简单路径都包含相同数目的黑色节点】`，因为 ==红色节点是可以与其父节点**合并**为一个 `3-` 节点的==

- 红黑树实现的其实是一个`完美的黑色平衡（把红黑树从根结点到叶子结点的黑色结点个数定义为高度）`

- 如果你将红黑树中所有的 `【红色链接放平】`，那么它所有的叶子节点到根节点的距离都是相同的。所以它并不是一个严格的平衡二叉查找树

![alt](https://img-blog.csdn.net/20160905092521430?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center)

### ★ 红黑树和 B+ 树的区别

- 树的分层，数据太大的时候，红黑树的树层级要比 B+ 树高（**红黑树首先是一颗 `二叉树`**）

### `2-3` 树与红黑树的区别

- `2-3` 树与红黑树的转换

  **`红节点与其父节点向上融合`**

  ![alt](https://img-blog.csdn.net/20160905092651228?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center)

- 对于这棵树，也可以用 `2-3-4` 树去理解，把 J、R、C、S 看成是红色节点，然后用同样的方式进行融合

  ```sh
  # [y] 表示是该节点为红色
  # 把红色节点拿掉，可以看出这也是一个黑色平衡的树
         [J]   M   [R]
         /     |    |    \
   [C]  E      L    P    [S]
   /     \
  A       H
  ```

### 红黑有什么特点

> - 并没有说不能两个子节点都是红色
> - 黑色节点把红色节点隔开，不会有两个红色节点相连

- 每个节点或是红色的，或是黑色的；根节点是黑色的

- 每个叶子节点是黑色的

- 如果一个节点是红色的，则它的两个子节点都是黑色的

- 对每个节点，从该节点到其所有后代叶子节点的简单路径上，`均包含相同数目的黑色节点`（所以说是相对平衡、黑色平衡嘛）

### 红黑树和 AVL 树的区别

- 当节点本身有序，比如 `[7, 6, 5, 4, 3]` ，构建出来的`【二叉查找树就变成了一条链表，时间复杂度降为 O（N）】`。为了避免这种情况，引入了 AVL 平衡二叉查找树

- 平衡二叉查找树在每次插入、删除节点时都会进行节点调整，使其严格满足平衡状态（左右子树高度差始终为 1）

- AVL 树是`严格的平衡二叉查找树` 。不管是执行插入还是删除操作，`都要通过旋转来保存平衡`，而因为旋转非常耗时，因此 `更适用于插入与删除次数比较少，但查找多的情况`

- 红黑树的`旋转次数少`，插入最多两次旋转，删除最多三次旋转，红黑树更适合 `对于搜索，插入，删除操作较多的情况`

- `map 、set、multiset、multimap` 的底层实现都是红黑树，epoll 模型的底层数据结构也是红黑树，linux 系统中 CFS 进程调度算法，也用到红黑树

### 红黑树是怎么实现减少旋转就能达到平衡的

> `通过【旋转和变色】来维护红黑树的规则`，变色就是让黑的变成红的，红的变成黑的，旋转又分为 【左旋转】 和 【右旋转】

- **左旋转**

  ![左旋转](https://img2018.cnblogs.com/blog/1890852/202001/1890852-20200126142341366-1415790505.png)

  ![alt](https://mmbiz.qpic.cn/mmbiz_gif/MOwlO0INfQoLqmAK6QYdbdUlbu7Oszlx3VVKzxAYIUN5a8VREhHyATNmfUAsdSOOnribxjiciaT7gNmibgu9WYHlVA/640?wx_fmt=gif&tp=webp&wxfrom=5&wx_lazy=1)

- **右旋转**

  ![右旋转](https://img2018.cnblogs.com/blog/1890852/202001/1890852-20200126142341600-690590092.png)

  ![alt](https://mmbiz.qpic.cn/mmbiz_gif/MOwlO0INfQoLqmAK6QYdbdUlbu7Oszlx1qZPPaqJ3n5eia6OypGAjQEicccsHGV56YhTZZUCDFJl7picxIhHONXVg/640?wx_fmt=gif&tp=webp&wxfrom=5&wx_lazy=1)

- **变换颜色**

  ![变换颜色](https://img2018.cnblogs.com/blog/1890852/202001/1890852-20200126142342390-2016453272.png)

## B 树（多路平衡搜索树）

`2-3` 树，`2-3-4` 树都有了，那是不是也有 `2-3-4-5` 树，`2-3-4-5--...-n` 树的存在呢？事实上是有的，这一类树统称为 B 树

- B 树表示的是一类树，它`允许一个节点可以有多于两个子节点`，同时，也是自平衡的，叶子节点的高度都是相同的

- 为了更好地区分一颗 B 树到底属于哪一类树，我们给它一个新的属性：`度（Degree）：一个节点能有多少个子节点`

- 具有度为 3 的 B 树，表示一个节点最多有三个子节点，也就是 2-3 树的定义。具有度为 4 的 B 树，表示一个节点最多有四个子节点，也就是 2-3-4 树的定义

- 图示为度为 4 的 B 树

  ![alt](https://mmbiz.qpic.cn/mmbiz_png/MOwlO0INfQoLqmAK6QYdbdUlbu7OszlxK0uHJatAdrs4Eicw5ZvTyoBo2O03r7G7IpmxibXXmLxZllN0gx4DFyvw/640?wx_fmt=png)

## B+ 树

- 在 `B- 树` （B-tree 树即 B 树）基础上，`为【叶子结点增加链表指针】，所有关键字都在叶子结点中出现，非叶子结点作为叶子结点的索引`；B + 树总是到叶子结点才命中

- 在 `B+ 树上增加了顺序访问指针`，也就是每个叶子节点增加一个`【指向相邻叶子节点的指针】`，这样一棵树成了数据库系统实现索引的首选数据结构

**索引存储结构：**

![alt](https://img-blog.csdn.net/20180509204328335?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MTQ2MjA0Nw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

**联合索引存储结构：**

![alt](https://img-blog.csdn.net/20180509204754682?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MTQ2MjA0Nw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

![alt](https://img-blog.csdnimg.cn/20200527211615989.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3RjOTc5OTA3NDYx,size_16,color_FFFFFF,t_70)

### 为什么 B+ 树要把数据存放在叶子节点

MySQL 默认每一节点层是存储 16k 数据，目的是为了`【使非叶子节点存储更多的索引】 key 值，控制树的高度`

假设：存储的主键索引是 bigint 类型，默认是 8b 大小，而存储子节点的地址是 6b，总共 14b。16kb/14b=1170，所以根节点可以存储 1170 个 key，假设有**三层的话，默认存储的数据 1k 的话，那么叶节点可以存储 16 个数据，`1170 * 1170 * 16 = 两千一百多万`**，两千多万的数据只需要三次 I/O 就可以找到数据。

### ★ B 树和 B+ 树的优缺点

- 在 B 树中，将键和值存放在内部节点和叶子节点

- 在 B+ 树中，【内部节点都是键，叶子节点同时存放键和值】，且相邻叶子节点前后都【有指针相连】

- B 树只适合`随机检索`，而 B+ 树同时支持`随机检索、顺序检索`

**`B 树的优点`**

- B 树的每一个节点都包含 key 和 value，因此经常访问的元素可能离根节点更近，因此`【访问更迅速】`

- B 树则需要进行每一层的递归遍历。相邻的元素可能在内存中不相邻，所以`【缓存命中】`性没有 B+树好

**`B+ 树的优点`**

- 内部节点上不包含数据信息，因此在内存页中 `能存放更多的索引，数据存放的更加紧密`；访问叶子节点上关联的数据也具有更好的缓存命中率

- 叶子结点都是相连的，因此`对整棵树的遍历只需要一次线性遍历叶子结点即可`，所有指向关键字的指针都存在叶子节点，所以`每次查找都是从根节点走到叶子节点，查找次数都相同所以查询速度更稳定`

- `非叶子节点只包含导航信息，不包含实际的值`，所有的叶子结点和相连的节点使用链表相连，`【便于区间查找和遍历】`

### ★ 为什么使用 `B+` 树而不是 `B` 树

[范围查询 B 树还是 B + 树](https://blog.csdn.net/weixin_39949297/article/details/110355209)

> - `【B+ 树更矮更胖】、【非叶子存储的索引更多】`，所有查询都是从根节点走到叶子结点，【查询稳定】
> - B+ 树仅用少量的层数就可以存储大量的数据，大大 `【减少磁盘 IO】`
> - B+ 树叶子结点之间通过指针相连，更`【适合做范围查询】`

![B树](https://img-blog.csdnimg.cn/img_convert/ece9c1a3c7afee84d1fab445179faa63.png)

- 所有键值分布在整个树中

- 任何关键字出现且只出现在一个节点中

- 搜索有可能在非叶子节点结束

- 在关键字全集内做一次查找，性能逼近二分查找算法

![B+树](https://img-blog.csdnimg.cn/img_convert/9ae2d6fb0ec7b2fb87a7c428e266acad.png)

- `可以【存储更多的索引】`

  所有关键字存储在叶子节点，非叶子节点不存储真正的 data

- `更适合【范围查询】`

  B+ 树木叶子结点之间通过指针相连

- B+ 树空间利用率更高，可`【减少 I/O 次数】`，磁盘读写代价更低

  InnoDB 中页的默认大小是 16KB，如果不存储数据，那么就可以存储更多的键值（索引），相应的树的阶数（度，节点的子节点数）就会更大，树就会 `更矮更胖`，查数据进行磁盘的 IO 次数会再次减少，数据查询的效率也会更快.

  - 一般来说，索引本身也很大，不可能全部存储在内存中，因此 **【索引往往以索引文件的形式存储的磁盘上】**；这样的话，索引查找过程中就要产生磁盘 I/O 消耗

  - B+ 树的内部结点并没有指向关键字具体信息的指针，只是作为索引使用，其内部结点比 B 树小，盘块能容纳的结点中关键字数量更多，一次性读入内存中可以查找的关键字也就越多，相对的，IO 读写次数也就降低了

  - IO 读写次数是影响索引检索效率的最大因素；`【数据量很大的时候，索引的体积也会很大，内存放不下的而从磁盘读取，树的层次太高的话，读取磁盘的次数就多了】`

- `B+ 树的【查询更加稳定】`

  B 树搜索有可能会在非叶子结点结束，越靠近根节点的记录查找时间越短，只要找到关键字即可确定记录的存在，其性能等价于在关键字全集内做一次二分查找。

  而在 B+ 树中，顺序检索比较明显，随机检索时，`【任何关键字的查找都必须走一条从根节点到叶节点的路，所有关键字的查找路径长度相同，所以每一个关键字的查询效率相当，且稳定】`

- `B 树在提高了磁盘 IO 性能的同时并没有解决元素遍历的效率低下的问题`

  B+ 树的叶子节点使用指针顺序连接在一起，只要遍历叶子节点就可以实现整棵树的遍历。而且在数据库中基于范围的查询是非常频繁的，而 B 树不支持这样的操作

- `增删文件（节点）时，效率更高`

  B+ 树的叶子节点包含所有关键字，并以有序的链表结构存储，这样可很好提高增删效率

### 哈希索引和 `B+` 树索引有什么区别

> `区间查询`、`顺序查询`

- **哈希索引不支持区间查询，适用于等值查询**

  - 多个数据在存储关系上是完全没有任何顺序关系的，所以，对于`【区间查询】是无法直接通过哈希索引查询的，就需要全表扫描。哈希索引只适用于【等值查询】的场景`

  - B+ 树是一种多路平衡查询树，所以他的`节点是有序的`，所以对于`区间查询的时候不需要做全表扫描`

- **哈希索引必须进行回表查询，B+ 树在覆盖索引的情况下无需【回表】**

  - 哈希索引底层就是 hash 表, 进行查找时, 调用一次 hash 函数就可以获取到相应的键值, 之后进行回表查询获得实际数据

  - B+ 树底层实现是多路平衡查找树, 对于每一次的查询都是从根节点出发, 查找到叶子节点方可以获得所查键值, 然后根据查询判断是否需要回表查询数据.

- **哈希索引不支持索引进行【排序】，原理同上**

- **哈希索引不支持【模糊查询】以及多列索引的最左前缀匹配**

  因为 hash 函数的不可预测，AAAA 和 AAAAB 的索引没有相关性

- **哈希索引【查询不稳定】，性能不可预测**

  - 如果有大量重复键值的情况下，`因为存在哈希碰撞问题`，哈希索引的效率会很低

  - B+ 树的查询效率比较稳定, `对于所有的查询都是从根节点到叶子节点`, 且树的高度较低

# 参考资料

- [★ 以 B tree 和 B+ tree 的区别来分析索引实现](https://www.jianshu.com/p/0371c9569736)

- [B 树与 B + 树简明扼要的区别](https://blog.csdn.net/zhuanzhe117/article/details/78039692)

- [25 张图演示红黑树](https://mp.weixin.qq.com/s/cjvkfh0D9AfDwNv0Kk5e8Q)

- [★ 清晰理解红黑树的演变 - 红黑的含义](https://www.cnblogs.com/tiancai/articles/9072813.html)

- [通过 2-3-4 树理解红黑树](https://zhuanlan.zhihu.com/p/269069974)

- [★ 从 2-3 树理解红黑树](https://www.jianshu.com/p/08024d26c152)

- [动画 | 什么是 2-3 树](https://mp.weixin.qq.com/s/kZo58Lq7rxjqO5M3c-fPRA)

- [动画 | 什么是红黑树](https://mp.weixin.qq.com/s/lm3WKiq2BvxRq8Ym03J-yw)

- [★ B 树、B + 树、LSM 树、红黑树以及其典型应用场景](https://blog.csdn.net/qq_22473611/article/details/88056206)
