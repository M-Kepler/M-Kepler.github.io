- [什么是索引下推](#什么是索引下推)
- [索引下推优化的原理](#索引下推优化的原理)
- [索引下推的具体实践](#索引下推的具体实践)
- [没有使用 ICP](#没有使用-icp)
- [索引下推使用条件](#索引下推使用条件)
- [问答区](#问答区)
- [总结](#总结)

> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [www.cnblogs.com](https://www.cnblogs.com/cy0628/p/16366561.html)

如果你在面试中，听到 "MySQL5.6"、"索引优化" 之类的词语，你就要立马 get 到，这个问的是 “索引下推”。

### 什么是索引下推

索引下推 (Index Condition Pushdown，简称 ICP)，是 MySQL5.6 版本的新特性，==它能减少回表查询次数，提高查询效率。==

### 索引下推优化的原理

我们先简单了解一下 MySQL 大概的架构：

![](https://img2022.cnblogs.com/blog/2174081/202206/2174081-20220611185128454-251810060.png)

MySQL 服务层负责 SQL 语法解析、生成执行计划等，并调用存储引擎层去执行数据的存储和检索。

==`索引下推`的**下推**其实就是指将部分上层（服务层）负责的事情，交给了下层（引擎层）去处理。==

**在没有使用 ICP 的情况下，MySQL 的查询：**

- 存储引擎读取索引记录；

- 根据索引中的主键值，定位并读取完整的行记录；

- 存储引擎把记录交给`Server`层去检测该记录是否满足`WHERE`条件。

**使用 ICP 的情况下，查询过程：**

- 存储引擎读取索引记录（不是完整的行记录）；

- 判断条件部分能否用索引中的列来做检查，条件不满足，则处理下一行索引记录；

- 条件满足，使用索引中的主键去定位并读取完整的行记录（就是所谓的回表）；

- 存储引擎把记录交给层，层检测该记录是否满足条件的其余部分。

### 索引下推的具体实践

理论比较抽象，我们来上一个实践。

使用一张用户表`tuser`，表里创建联合索引（name, age）。

![](https://img2022.cnblogs.com/blog/2174081/202206/2174081-20220611185304818-101692874.png)

如果现在有一个需求：检索出表中`名字第一个字是张，而且年龄是10岁的所有用户`。那么，SQL 语句是这么写的：

```sql
select * from tuser where name like '张%' and age=10;

```

假如你了解索引最左匹配原则，那么就知道这个语句在搜索索引树的时候，只能用 `张`，找到的第一个满足条件的记录 id 为 1。　因为==对于联合索引 mysql 会一直向右匹配直到遇到范围查询 `(>、<、between、like)` 就停止匹配==

那接下来的步骤是什么呢？

### 没有使用 ICP

在 MySQL 5.6 之前，存储引擎根据通过联合索引找到`name like '张%'` 的主键 id（1、4），逐一进行回表扫描，去聚簇索引找到完整的行记录，server 层再对数据根据`age = 10 进行筛选`。

**回表和索引覆盖的概念：**

- MySQL 通过普通索引没法一次性将数据拿全的情况下，通过普通索引获取主键值，再通过主键值到聚集索引中定位到记录，这个过程就叫回表。

- 可以通过建立覆盖索引来减少回表，比如现在要通过身份证号查姓名，那就建立身份证号和姓名的联合索引 `(id，name)` ，当查询时可以通过这个索引直接拿到姓名 name 得值，不再需要去聚集索引里查找了，这就是覆盖索引。

**MySQL 在 InnoDB 引擎下支持两种索引**

- 聚集索引 ：索引里（B+树的叶子结点上）存储的是数据行（真实的数据）

- 普通索引 ：索引里（B+树的叶子结点上）存储的是主键

这里着重说一下聚集索引，官方文档有以下描述

- 在有主键的表，InnoDB 将主键作为聚集索引

- 没有主键的表，InnoDB 使用第一个唯一索引作为聚集索引

- 即没有主键也没有唯一索引时，MySQL 将生成一个隐藏的 6 字节大小的 row ID 字段作为聚集索引

我们看一下示意图：

![alt](https://pics5.baidu.com/feed/b151f8198618367a7d07a2dd3e7ce5ddb31ce539.jpeg?token=28b954d84c29cab120da924853b4af64)

可以看到需要回表两次，把我们联合索引的另一个字段`age`浪费了。

**使用 ICP**

而 MySQL 5.6 以后， 存储引擎根据（name，age）联合索引，找到，由于联合索引中包含列，所以存储引擎直接再联合索引里按照 `age = 10` 过滤。按照过滤后的数据再一一进行回表扫描。

我们看一下示意图：

![](https://img2022.cnblogs.com/blog/2174081/202206/2174081-20220611185746053-801231500.png)

可以看到只回表了一次。除此之外我们还可以看一下执行计划，看到`Extra`一列为 `Using index condition`，意思是用到了索引下推。

```sql
+----+-------------+-------+------------+-------+---------------+----------+---------+------+------+----------+-----------------------+
| id | select_type | table | partitions | type  | possible_keys | key      | key_len | ref  | rows | filtered | Extra                 |
| 1  | SIMPLE      | tuser | NULL       | range | na_index      | na_index | 102     | NULL | 2    | 25.00    | Using index condition |
+----+-------------+-------+------------+-------+---------------+----------+---------+------+------+----------+-----------------------+

```

### 索引下推使用条件

- 只能用于`range`、 `ref`、 `eq_ref`、`ref_or_null`访问方法；

- 只能用于`InnoDB`和 `MyISAM`存储引擎及其分区表；

- 对存储引擎来说，索引下推只适用于二级索引（也叫辅助索引）;

  ==索引下推的目的是为了**减少回表次数**，也就是要减少 IO 操作。对于的**聚簇索引**来说，数据和索引是在一起的，不存在回表这一说。==

- 引用了子查询的条件不能下推；

- 引用了存储函数的条件不能下推，因为存储引擎无法调用存储函数。

### 问答区

**问题 1** 当复合索引列为（name，age，address）时，以下 SQL 能使用索引吗？

```sql
select * from student where name like 'peng%' and age = 23;

```

可以

遇到 like 会中断后续元素的匹配，但只能使用 name 这个字段，mysql 会一直向右匹配直到遇到范围查询 `(>、<、between、like)` 就停止匹配。范围列可以用到索引，但是范围列后面的列无法用到索引。即索引最多用于一个范围列，因此如果查询条件中有两个范围列则无法全用到索引。

**问题 2** 索引下推只能存在联合索引里吗？

是的，非联合索引无法使用索引下推。

**问题 3** 索引下推在哪些情况下无法使用？

- 下推条件遇到子查询

- 下推条件遇到函数

- 非 InnoDB 表和 MyISAM 表

**问题 4** 索引下推如何开启和关闭？

```sql
-- 索引下推默认是开启的
set optimizer_switch='index_condition_pushdown=off'; // 关闭
set optimizer_switch='index_condition_pushdown=on'; // 开启

```

### 总结

索引下推在非主键索引上的优化，可以有效减少回表的次数，大大提升了查询的效率，在平时工作中可以根据业务情况通过优化索引来达到使用索引下推，提高业务吞吐量。

索引下推 (ICP) 是针对 MySQL 使用索引从表中检索数据行的情况的优

- 在没有索引下推的情况下，MySQL 通过存储引擎遍历索引来定位表中的数据行并将它们返回给 MySQl 服务器，服务器再进行 WHERE 条件的判断，确认是否将数据行加入结果集。

- 开启索引下推，且 WHERE 条件部分可以仅使用索引中的列来评估，这时 MySQL 服务器会将这部分 WHERE 条件下推到存储引擎，接着存储引擎使用索引条目评估推送的索引条件，仅当满足该条件时才从表中进行读取

索引下推可以减少存储引擎访问数据表的次数以及 MySQL 服务器访问存储引擎的次数。
