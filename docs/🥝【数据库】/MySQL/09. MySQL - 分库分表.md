- [参考资料](#参考资料)
- [高可用](#高可用)
  - [高可用方案有哪些呢](#高可用方案有哪些呢)
- [分库分表](#分库分表)
  - [什么叫分库分表](#什么叫分库分表)
  - [为什么要分库分表](#为什么要分库分表)
  - [如何分表](#如何分表)
    - [垂直拆分](#垂直拆分)
    - [水平拆分](#水平拆分)
  - [如何分库](#如何分库)
  - [分表后的 `ID` 怎么保证唯一性](#分表后的-id-怎么保证唯一性)
  - [分库分表就一定好吗, 给系统带来那些问题](#分库分表就一定好吗-给系统带来那些问题)
- [主从读写分离](#主从读写分离)
  - [主从读写分离是怎么做的](#主从读写分离是怎么做的)

## 参考资料

- [面试官：你了解 MySQL 主从复制吗](https://mp.weixin.qq.com/s/5-qCk1WX8h8VDDXDNdV9FA)

- [我们为什么要分库分表](https://mp.weixin.qq.com/s/gmrrHz3Un3yxOSREA1Oc3g)

- [高并发下数据库分库分表面试题整理](https://www.jianshu.com/p/05da0fc0950e)

## 高可用

### 高可用方案有哪些呢

- 分库分表

- `MySQL主从架构` 一个 master，多个 salves，主从读写分离

## 分库分表

### 什么叫分库分表

- 分库分表分为垂直和水平两个方式，一般来说我们拆分的顺序是`先垂直后水平`

- 如果磁盘或网络有 IO 瓶颈，那就要分库和垂直分表

- 如果是 CPU 瓶颈，即查询效率偏低，水平分表

- 可以在客户端与数据库之间加一个中间件，来解决分库分表后的数据操作变复杂的问题

### 为什么要分库分表

[为什么要分库分表](https://mp.weixin.qq.com/s/vl2h_0OpxEf8CSHJ0o9Fxg)

[MySQL 分库分表及其平滑扩容方案](https://mp.weixin.qq.com/s/Zd0mDQ5i9VhmJ7r39yXHxg)

> 分库分表会为数据库维护和业务逻辑带来一系列复杂性和性能损耗，除非预估的业务量大到万不得已，切莫过度设计、过早优化。

- 单库最多支持的 `2000 【并发量】`，随着查询量的增加单台数据库服务器已经没办法支撑，而且一个健康的单库并发值你最好保持在每秒 1000 左右，不要太大，太大会导致单台 DB 的 `【存储空间】`不够。那么你就可以将一个库的数据拆分到多个库中，访问的时候就访问一个库好了。

- 当单表达到`两千万`的时候，单表数据量太大，会极大影响 sql 执行的性能

  [为什么大家说mysql数据库单表最大两千万？依据是啥？](https://mp.weixin.qq.com/s?__biz=Mzg5NDY2MDk4Mw==&mid=2247488133&idx=1&sn=169533ab3946f2f018478d6d2abf532a&scene=21)

### 如何分表

#### 垂直拆分

> 比如说用户信息，可以分成用户基本信息、用户扩展信息两个表

![alt](https://mmbiz.qpic.cn/mmbiz_jpg/iaIdQfEric9TzJ2xibdC2PtmFS4HPNwycxvCibFseWD1EgHx2ia5qnbVkPhiavGSJPicYHCrWnTibXkUGKW205B5N6PoBw/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

- 垂直拆分优点

  - 可以使得列数据变小，减少 `I/O`次数
  - 可以简化表结构，易于维护

- 垂直拆分缺点

  - 主键会出现冗余，需要管理冗余列
  - 会引起 `join` 操作
  - 垂直分区使得事务变得更加复杂

#### 水平拆分

> 比如日志表，可以根据日期不同，拆分成多个表

![alt](https://mmbiz.qpic.cn/mmbiz_jpg/iaIdQfEric9TzJ2xibdC2PtmFS4HPNwycxvMPvFZLH34boib3uLEk9lpRYRz29A92f8XzJPDyggtDkW9cTx5y8U7dg/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

- 水平拆分优点

  - 支持大数据量存储
  - 应用端改造也少

- 水平拆分缺点

  - 分片事务难以解决
  - 跨节点 `join` 性能差
  - 逻辑复杂

### 如何分库

![alt](https://mmbiz.qpic.cn/mmbiz_png/uL371281oDGutQ05TDIpkU9ePibjJOPW6ma178aGCM1j76IbSVddJT8XC9TIwZu6w3v1MWJibibw7Tv9Wlvlnibr9A/640?wx_fmt=png)

### 分表后的 `ID` 怎么保证唯一性

因为我们主键默认都是自增的，那么分表之后的主键在不同表就肯定会有冲突

- `【设定步长】`，比如 `1-1024` 张表我们设定 `1-1024` 的基础步长，这样落到不同表就不会冲突

- ==`分布式 ID`==，自己实现一套分布式 ID 生产的算法或者使用开源算法

- 分表后不使用主键作为查询依据，而是每张表单独`新增一个字段作为唯一主键使用`，比如订单表的订单号是唯一的，不管最终落在哪张表都是基于订单号作为查询依据的，更新也一样

### 分库分表就一定好吗, 给系统带来那些问题

> 分库分表之后的复杂性

- `关联查询变得复杂`

  - 比如查询用户信息，不仅要查基础信息表还要查扩展信息表，有时仅仅是为了获取扩展信息的某个字段，而不得不去关联一个几百几千万的表。
  - 解决方案 1: 增加冗余字段，把常用字段放到一张表中，避免进行关联查询
  - 解决方案 2: 全局表，比如一些基础信息表，可以在每个库都存一份

- `分布式 ID`

  > 如果使用 MySQL 数据库在单库单表可以使用 id 自增作为主键，分库分表了之后就不行了，会出现 id 重复

  - UUID

  - 基于数据库自增单独维护一张 ID 表

  - 号段模式

  - Redis 缓存

  - 雪花算法（Snowflake）

- `分布式事务`

  > 单数据库可以用本地事务搞定，使用多数据库就只能通过分布式事务解决了

  - 常用解决方案有：基于可靠消息（MQ）的解决方案、两阶段事务提交、柔性事务等

- `排序、分页、函数计算问题`

  > 在使用 SQL 时 order by， limit 等关键字需要特殊处理，一般来说采用分片的思路

  - `在每个分片上执行相应的函数`，然后将各个分片的结果集进行`汇总和再次计算`，最终得到结果。

- `多数据源`

  > 分库分表之后可能会面临从多个数据库或多个子表中获取数据，一般的解决思路有：客户端适配和代理层适配

  增加代理层，由代理层做处理，对客户端来说是透明的

## 主从读写分离

同步机制见 [MySQL - 主从同步机制.md]

### 主从读写分离是怎么做的

- `代码封装`

  > 讲白了就是代码层面抽出一个中间层，由中间层来实现读写分离和数据库连接。

  搞了个代理类，对外暴露正常的读写接口，里面封装了逻辑，将读操作指向从库的数据源，写操作指向主库的数据源。

  - `优点`

    简单，并且可以根据业务定制化变化，随心所欲。

  - `缺点`

    如果数据库宕机了，发生主从切换了之后，就得修改配置重启。如果系统是多语言的话，需要为每个语言都实现一个中间层代码，重复开发

- `中间件`

  > 一般而言是独立部署的系统，客户端与这个中间件的交互是通过 SQL 协议的。

  - 在客户端看来连接的就是一个数据库，通过 SQL 协议交互也可以屏蔽多语言的差异

  - `缺点`

    使`系统变得复杂`，整体架构多了一个系统需要维护，并且可能成为性能瓶颈，毕竟交互都需要经过它中转

  - 常见的开源数据库中间件有：官方的 MySQL-Proxy、360 的 Atlas、Mycat 等

# 数据库高可用方案

## 双机主备

![alt](https://mmbiz.qpic.cn/mmbiz_png/PoF8jo1PmpzVFmLO1ibDOLCEzlt7LUb5awssRLatT7YbdjrNqa6EI1ic8icMS5xxP1DVhsou7BgYtR6gVbqABbDkg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

- 架构描述

  两台机器 A 和 B，A 为主库，负责读写，B 为备库，只备份数据。如果 A 库发生故障，B 库成为主库负责读写。修复故障后，A 成为备库，主库 B 同步数据到备库 A

- 优点

  一个机器故障了可以自动切换，操作比较简单。

- 缺点

  只有一个库在工作，读写压力大，未能实现读写分离，并发也有一定限制

## 一主一从

![alt](https://mmbiz.qpic.cn/mmbiz_png/PoF8jo1PmpzVFmLO1ibDOLCEzlt7LUb5a87jCskHTmPFao2r7aC7b7LG0GbvfrDZsXZFFyjLhfSKs6KzfOrdxKA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

- 架构描述

  两台机器 A 和 B，A 为主库，负责读写，B 为从库，负责读数据。如果 A 库发生故障，B 库成为主库负责读写。修复故障后，A 成为从库，主库 B 同步数据到从库 A。

- 优点

  从库支持读，分担了主库的压力，提升了并发度。一个机器故障了可以自动切换，操作比较简单。

- 缺点

  一台从库，并发支持还是不够，并且一共两台机器，还是存在同时故障的机率，不够高可用。

## 一主多从

![alt](https://mmbiz.qpic.cn/mmbiz_png/PoF8jo1PmpzVFmLO1ibDOLCEzlt7LUb5aIoVD2EhrMfDV1e7m6s6Jf6PIWLnfT9RYqmzjfzuJKhyhAo67pqSbpA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

- 架构描述

  一台主库多台从库，A 为主库，负责读写，B、C、D 为从库，负责读数据。如果 A 库发生故障，B 库成为主库负责读写，C、D 负责读。修复故障后，A 也成为从库，主库 B 同步数据到从库 A。

- 优点

  多个从库支持读，分担了主库的压力，明显提升了读的并发度。

- 缺点

  只有台主机写，因此写的并发度不高

## `MariaDB` 同步多主机

MariaDB 是 MySQL 关系数据库管理系统的一个分支。 MySQL 的原始开发人员在 Oracle 收购 MySQL 后提出的关注之后创建了 MariaDB

![alt](https://mmbiz.qpic.cn/mmbiz_png/PoF8jo1PmpzVFmLO1ibDOLCEzlt7LUb5adj3UePCxxS5jialDRJr84XOicxdCf1jrWYWX3gfHLOPoPK3EDmoneRnQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

- 架构描述

  有代理层实现负载均衡，多个数据库可以同时进行读写操作；各个数据库之间可以通过 Galera Replication 方法进行数据同步，每个库理论上数据是完全一致的。

- 优点

  读写的并发度都明显提升，可以任意节点读写，可以自动剔除故障节点，具有较高的可靠性。

- 缺点

  数据量不支持特别大。要避免大事务卡死，如果集群节点一个变慢，其他节点也会跟着变慢。

## 数据库中间件

![alt](https://mmbiz.qpic.cn/mmbiz_png/PoF8jo1PmpzVFmLO1ibDOLCEzlt7LUb5aGvMbOG0Nl6ibPILiamAf4CSfvf7tOG1kEhhZCbbMvvcwGwJwHxySTLrQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

- 架构描述

  Mycat 分片存储，每个分片配置一主多从的集群。

- 优点

  解决高并发高数据量的高可用方案

- 缺点

  维护成本比较大

# 其他

- [基因分库分表](https://juejin.cn/post/6964028801626046471)，淘宝的订单就是这样，把后继好的后几位作为订单的一部分，查询的时候，直接截取这几位，然后对分表量取模就可以直接定位到那张表了
