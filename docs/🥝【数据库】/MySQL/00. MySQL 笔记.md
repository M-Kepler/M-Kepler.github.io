- [参考资料](#参考资料)
- [MySQL](#mysql)
  - [安装部署](#安装部署)
  - [配置](#配置)
  - [使用](#使用)
- [架构](#架构)
- [学习过程中的疑问](#学习过程中的疑问)
- [排障指南](#排障指南)
- [其他](#其他)

# 参考资料

- [`MySQL` 的锁](https://blog.csdn.net/hxpjava1/article/details/79407961)

- [开启远程访问](https://www.cnblogs.com/lyq-biu/p/10859273.html)

# MySQL

![alt](https://baiyp.ren/images/mysql/mysql01.png)

## 安装部署

- [测试数据导入](https://baiyp.ren/Docker%E5%AE%89%E8%A3%85MySql.html#MySQL%E5%87%86%E5%A4%87%E6%95%B0%E6%8D%AE)

## 配置

- 查看配置

  ```sh
  mysql -uroot -proot -e "show variables like 'log_bin%'"

  ```

## 使用

- [怎么递增地修改一个表数据的某个字段](https://blog.csdn.net/guoxiaoweitaiyuan/article/details/104535774)

  ```sql
  set @rownum=0;
  update bbc_device set device_list_id=(select @rownum := @rownum + 1 as nid);

  ```

- [根据 A 表去更新 B 表](https://blog.csdn.net/u012604745/article/details/80642015)

  ```sql
  update bbc_device a join bbc_device_list b on a.device_list_id = b.id set b.device_id=a.id;

  ```

- 查看连接数

  ```sql
  show full processlist;
  select * from information_schema.processlist where INFO is not NULL;

  ```

- 查看表索引

  ```sql
  SHOW INDEX FROM tb_name;

  ```

- 显示警告信息

  ```sql
  show warnings;

  ```

- 增删字段

  ```sql
  -- 删
  alter table upgrade_plan drop column auto_join;

  -- 增
  alter table upgrade_plan add column retry_time int default 0;

  ```

- 数据库导出

  ```sql
  mysqldump -u 用户名 -p 数据库名 > 导出的文件名

  ```

- 数据表导出导入

  [mysql 导入报@@GLOBAL.GTID_PURGED can only be set when @@GLOBAL.GTID_EXECUTED is empty 错误](https://www.cnblogs.com/xzlive/p/15589204.html)

  ```sql
  -- 导出
  mysqldump -uxxx -pxxx db_name tb1 tb2 tb3 > backup.sql

  -- 导入
  mysql -uxxx -pxxx db_name < backup.sql

  -- 批量导入（注意文件顺序）
  for SQL in *.sql; do mysql -uroot -p"xxx" mydb < $SQL; done

  ```

- 导出 csv

  ```sql
  -- 导出 csv
  -- ERROR 1290 (HY000) at line 1: The MySQL server is running with the --secure-file-priv option so it cannot execute this statement
  -- 修改 MySQL 配置文件 my.ini，添加 secure_file_priv="/root/hjj"，重启 mysql

  -- ERROR 1 (HY000) at line 1: Can't create/write to file'/xxxx/cfg_dict.csv' (Errcode: 13 - Permission denied)
  -- https://blog.csdn.net/weixin_30681615/article/details/102005340
  -- chmod -R 777 /path/to/your/export

  select * from test into outfile '/tmp/test.csv' fields terminated by ","  escaped by '' optionally enclosed  by ''   lines terminated by '\n' ;

  ```

- [desc 看不到表字段注释信息](https://blog.51cto.com/u_3664660/3213261)

  改用 `show full fields from [tablename]` 或者 `show create table [table_name]`

- [复制一行](https://www.learnfk.com/question/mysql/11331573.html)

  ```sql
  insert into my_table(col1, col2) select col1, col2 from my_table where pk_id=[row_id];
  ```

- `insert into` 多条数据

  ```sql
  insert into my_table values
  (1, "xxx", "yyy", "2030-01-02 11:10:09"),
  (2, "xxx", "yyy", "2030-01-02 11:10:09");
  ```

- 查看存储过程

  ```sql
  SHOW PROCEDURE STATUS LIKE '%xxx';
  -- 删除
  DROP PROCEDURE [ IF EXISTS ] [procedure_name]; -- 存储过程名称不要加双引号
  ```

- [MySQL 存储过程中“ @”符号的用法是什么](https://www.nhooo.com/note/qa019r.html)

- 模糊查找表 `show tables like '%log%';`

# 架构

![alt](https://pic2.zhimg.com/v2-f8d848179f49e357c4e348c68b4e62b5_r.jpg)

# 学习过程中的疑问

# 排障指南

- `The server quit without updating PID file（/var/run/mysqld/mysqld.id`

  ```sh
  mysqld: Can't create/write to file '/tmp/ibxzV7PR' (Errcode: 13 - Permission denied)
  2021-03-10T16:25:28.308867+08:00 0 [ERROR] InnoDB: Unable to create temporary file; errno: 13
  2021-03-10T16:25:28.308873+08:00 0 [ERROR] InnoDB: Plugin initialization aborted with error Generic error

  # 给 /tmp 加个 777 的权限
  ```

# 其他

- `mysql` 最多可以查多少数据

  比如有一亿数据，然后做分页，真的能分页出来吗

- `mysql` 每秒最多处理 `2000` 个请求

- 连接池

  - 如果你有 10000 个并发用户，设置一个 10000 的连接池基本等于失了智。1000 仍然很恐怖。即是 100 也太多了。你需要一个 10 来个连接的小连接池，然后让剩下的业务线程都在队列里等待。连接池中的连接数量应该等于你的数据库能够有效同时进行的查询任务数（通常不会高于 2\*CPU 核心数）。

  - 我们经常见到一些小规模的 web 应用，应付着大约十来个的并发用户，却使用着一个 100 连接数的连接池。这会对你的数据库造成极其不必要的负担

```
1. 可用反引号（`）为标识符（库名、表名、字段名、索引、别名）包裹，以避免与关键字重名！中文也可以作为标识符！
2. 每个库目录存在一个保存当前数据库的选项文件db.opt。
3. 注释：
    单行注释 # 注释内容
    多行注释 /* 注释内容 */
    单行注释 -- 注释内容        (标准SQL注释风格，要求双破折号后加一空格符（空格、TAB、换行等）)
4. 模式通配符：
    _    任意单个字符
    %    任意多个字符，甚至包括零字符
    单引号需要进行转义 \'
5. CMD命令行内的语句结束符可以为 ";", "\G", "\g"，仅影响显示结果。其他地方还是用分号结束。delimiter 可修改当前对话的语句结束符。
6. SQL对大小写不敏感
7. 清除已有语句：\c
```

- [结果输出到文件](https://www.cnblogs.com/edgedance/p/7090800.html)

- [MySQL 锁的总结 和 一次插入意向锁的死锁还原分析](https://blog.csdn.net/qq624202120/article/details/108594107)

- [MySQL Lock--gap before rec insert intention waiting](https://www.cnblogs.com/gaogao67/p/11042853.html)

- [并发插入引发的死锁问题排查](https://blog.csdn.net/qq_16681169/article/details/73359670)

- [在一个事务中，先插入再查询，能查到数据吗](https://blog.csdn.net/lpp_dd/article/details/83183816)

- [mysql for update 死锁问题](https://www.jianshu.com/p/2b258bfe00e5)

- [For update 带来的思考](https://www.cnblogs.com/Kidezyq/p/9239484.html?utm_source=debugrun&utm_medium=referral)

- [重复插入相同数据导致 deadlock 问题：Deadlock found when trying to get lock； try](https://blog.csdn.net/u013905744/article/details/102897226)

- [意向锁导致死锁](https://blog.csdn.net/wuyu6394232/article/details/99061955)
