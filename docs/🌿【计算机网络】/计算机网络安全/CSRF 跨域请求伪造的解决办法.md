- [CSRF 是什么](#csrf-是什么)
- [CSRF 能干嘛](#csrf-能干嘛)
- [CSRF 特性](#csrf-特性)
- [CSRF 原理](#csrf-原理)
- [如何进行防御](#如何进行防御)
  - [服务器端表单 hash 认证](#服务器端表单-hash-认证)
  - [验证 http Referer 字段](#验证-httpreferer-字段)
  - [在 HTTP 头中自定义属性并验证](#在-http-头中自定义属性并验证)
  - [及时清理认证 Cookie](#及时清理认证-cookie)
  - [通过图形验证码](#通过图形验证码)

> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [www.cnblogs.com](https://www.cnblogs.com/hutuzhu/p/5919400.html)

中秋节时候我们的应用在短信验证码这块被恶意刷单，比如被用来做垃圾短信之类的，如果大规模被刷也能造成不小的损失。这还只是短信验证码，如果重要的 API 遭到 CSRF 的攻击，损失不可估量。所以紧急加班解决了 CSRF 的攻击问题。

## CSRF 是什么

CSRF（Cross-site request forgery），中文名称：跨站请求伪造，也被称为：one click attack/session riding，缩写为：CSRF/XSRF。

## CSRF 能干嘛

你这可以这么理解 CSRF 攻击：攻击者盗用了你的身份，以你的名义发送恶意请求。CSRF 能够做的事情包括：以你名义发送邮件，发消息，盗取你的账号，甚至于购买商品，虚拟货币转账...... 造成的问题包括：个人隐私泄露以及财产安全。

## CSRF 特性

依靠用户标识危害网站

利用网站对用户标识的信任

欺骗用户的浏览器发送 HTTP 请求给目标站点

另外可以通过 IMG 标签会触发一个 GET 请求，可以利用它来实现 CSRF 攻击。

## CSRF 原理

![alt](https://images2015.cnblogs.com/blog/570037/201609/570037-20160929112301375-194534572.jpg)\*\*

简单来说，CSRF 必须经过两个步骤：

1、用户访问可信任站点 A，并产生了相关的 cookie；

2、用户在访问 A 站点时没有退出，同时访问了危险站点 B；

大家同时访问多个网站是很正常的事情，所以也很容易遭到 CSRF 的攻击。

**举个栗子：**

```
某电商网站A，你购买时候支付的操作是：http://www.market.com/Transfer.php?bankId=11&money=1000;
某危险网站B，他有段代码是 <img src=http://www.market.com/Transfer.php?bankId=11&money=1000>
```

访问 A 支付后你会发现银行卡里面多扣了 1000 块钱，why？通过 get 方式，你在访问 A 网站进行支付操作时，A 网站保存了你的 cookie 信息，如果 B 网站拿到了你的 cookie 或者他伪造的数据刚好就是 cookie 里的，就能伪造你的请求，进行同样的支付操作。

也许你会说，我换成 post 请求不就行了，但是如果你的 server 代码没有处理，一样可以进行伪造。

## 如何进行防御

### 服务器端表单 hash 认证

在所有的表单里面随机生成一个 hash，server 在表单处理时去验证这个 hash 值是否正确，这样工作量比较大，我们之前所有的表单都没添加！！！，好几十个页面，这个当前处境不切实际

### 验证 http Referer 字段

根据 HTTP 协议，在 HTTP 头中有一个字段叫 Referer，它记录了该 HTTP 请求的来源地址。在通常情况下，访问一个安全受限页面的请求必须来自于同一个网站。比如某银行的转账是通过用户访问 http://bank.test/test?page=10&userID=101&money=10000 页面完成，用户必须先登录 bank.test，然后通过点击页面上的按钮来触发转账事件。当用户提交请求时，该转账请求的 Referer 值就会是转账按钮所在页面的 URL(本例中，通常是以 bank. test 域名开头的地址)。而如果攻击者要对银行网站实施 CSRF 攻击，他只能在自己的网站构造请求，当用户通过攻击者的网站发送请求到银行时，该请求的 Referer 是指向攻击者的网站。因此，要防御 CSRF 攻击，银行网站只需要对于每一个转账请求验证其 Referer 值，如果是以 bank. test 开头的域名，则说明该请求是来自银行网站自己的请求，是合法的。如果 Referer 是其他网站的话，就有可能是 CSRF 攻击，则拒绝该请求。

### 在 HTTP 头中自定义属性并验证

自定义属性的方法也是使用 token 并进行验证，和前一种方法不同的是，这里并不是把 token 以参数的形式置于 HTTP 请求之中，而是把它放到 HTTP 头中自定义的属性里。通过 XMLHttpRequest 这个类，可以一次性给所有该类请求加上 csrftoken 这个 HTTP 头属性，并把 token 值放入其中。这样解决了前一种方法在请求中加入 token 的不便，同时，通过这个类请求的地址不会被记录到浏览器的地址栏，也不用担心 token 会通过 Referer 泄露到其他网站。

我们就是采用的这种方法，因为基本上所有的请求都是通过 ajax，我们通过重新封装 ajax，在 ajax 头部添加一个 token，server 去识别这个 token，如果请求没有这个 token 或者错误就拒绝。

### 及时清理认证 Cookie

CSRF 攻击是有条件的，当用户访问恶意链接时，认证的 cookie 仍然有效，所以当用户关闭页面时要及时清除认证 cookie，对支持 TAB 模式 (新标签打开网页) 的浏览器尤为重要。

### 通过图形验证码

相对来说图形验证码应该是最安全的，但是我们不可能在所有的 API 上去加上这么个玩意儿，一般是在表单，比如注册，登录等，当用户频繁操作时出现，避免影响用户体验

所以建议以后 ajax 请求都尽量加上 token 验证，虽然不一定能防御所有的 CSRF 攻击，但是可以大幅度提升接口的安全性，中秋节加班通过紧急修复后，CSRF 攻击基本没有了。
