- [分层模型](#分层模型)
  - [什么叫 `端到端`、`点到点`](#什么叫-端到端点到点)
  - [为什么要分层](#为什么要分层)
  - [各层的作用](#各层的作用)
- [计算机网络基础 - `TCP/IP`](#计算机网络基础---tcpip)
- [`IP` 数据报](#ip-数据报)
  - [`IP` 报文结构](#ip-报文结构)
  - [`IP` 数据报校验和](#ip-数据报校验和)
  - [`IP` 地址分类](#ip-地址分类)
    - [地址分类](#地址分类)
    - [私有地址](#私有地址)

# 分层模型

> `OSI` 是参考的模型，`TCP/IP` 才是实际应用中的模型

![alt](https://mmbiz.qpic.cn/mmbiz_jpg/ibBMVuDfkZUn2BsPqwzxiaY6YX7BD4he0nd4TJ6Fg7gWJIoLkWnZMAJSrf5nsWwYZ77aFiaibFicWhVUnK9EE5yN8dg/640?wx_fmt=jpeg)

- 物理层负责 0、1 比特流与物理设备电压高低、光的闪灭之间的互换

- 数据链路层负责将 0、1 序列划分为数据帧，添加报文头，mac 地址，从一个节点传输到临近的另一个节点

- 网络层： 传输的是数据报文

- 传输层： 传输的是数据段，到了传输层这里才是`端到端` 的传输，前面都是点到点

## 什么叫 `端到端`、`点到点`

- `网络层、数据链路层` 都是点到点通信

  因为他们的报文都是包含地址的，`mac`地址、`ip`地址，都是为了**从一个设备发送到另一个设备** 这样就像点连成线一样。

- 对于`传输层` 就说成是端到端通信

  它关心的是发送端到接收端直接的网络连接，并不关心中间经过了多少台设备

## 为什么要分层

- 层次之间`相互独立`

  某一层并不需要知道它的下一层是如何实现的，而仅仅需要知道该层通过层间的接口所提供的服务。这样，整个问题的复杂程度就下降了。也就是说上一层的工作如何进行并不影响下一层的工作，这样我们在进行每一层的工作设计时只要保证接口不变可以随意调整层内的工作方式。

- `灵活性好`

  当任何一层发生变化时，只要层间接口关系保持不变，则在这层以上或以下层均不受影响。当某一层出现技术革新或者某一层在工作中出现问题时不会连累到其它层的工作，排除问题时也只需要考虑这一层单独的问题即可。

- `易于实现和维护`

  这种结构使得实现和调试一个庞大又复杂的系统变得易于处理，因为整个的系统已经被分解为若干个相对独立的子系统。进行调试和维护时，可以对每一层进行单独的调试，避免了出现找不到、解决错问题的情况。

- `结构上可分割开`

  各层都可以采用最合适的技术来实现。技术的发展往往不对称的，层次化的划分有效避免了木桶效应，不会因为某一方面技术的不完善而影响整体的工作效率。

- `能促进标准化工作`

  因为每一层的功能及其所提供的服务都已有了精确的说明。标准化的好处就是可以随意替换其中的某一层，对于使用和科研来说十分方便。

## 各层的作用

  ```
  应用层: 用户与网络间的接口    http

  运输层: 进程到进程间的接口    tcp/udp

  网络层: 主机到主机间的接口    ip

  数据链路层: 相邻结点间的接口  mac、以太网

  物理层: 物理介质间的接口
  ```

- 套接字接口就是七层模型中应用层以下封装的一个系统调用

# 计算机网络基础 - `TCP/IP`

- [TCP/IP 协议及数据格式](https://www.jianshu.com/p/39b23068bb0f)

- [TCP 分组、IP 分组、MTU、MSS](https://blog.csdn.net/weixin_47416396/article/details/115606106)
- `IEEE 和 802.3` 标准

```log
[PC1] --------> [ROUTER1] --------> [ROUTER2] --------> [ROUTER3] --------> [PC2]
                    |                  |                     |
                    ↓                  ↓                     ↓
                MTU = 1500         MTU = 576             MTU = 1492      路径MTU = 576
                                       |
                                       ↓
                         MSS = 576 - 20(IP头) - 20(TCP头) = 536
```

- `MTU (maximum transmission unit)` 最大传输单元

  `IEEE 和 802.3` 标准的最大值分别是 `1500 和 1492` 字节（以太网环境是这样，但是实际经过那么多路由就不一定了），超过最大字节数就要对数据包做**分片**（分组）

- 路径 `MTU`

  数据包在网络中传输，需要经过很多主机、路由器，路径 `MTU` 即表示 `两台通信主机路径中最小的 MTU`

- `MSS (maximum segment size)` 最长报文长度

  - 路由器`MTU` 一般是`576`，再扣除掉`IP、TCP` 头部，所以`MSS` 默认为`576 - 20 - 20 = 536` 个字节

  - 所以设置`MSS` 可以避免`数据报分片`

  - 当传输的数据不超过`536` 字节就一般不会发生数据报`分片`，所以**应用层的缓冲区不要设置大于 `536` 字节**

- `IP 分片`

  - 指的是把`IP` 的数据部分进行分成多个报文发送，切分出来的数据都要加上`IP` 头部

  - IP 层的上层是传输层（tcp/udp tcp 的头部为 20Byte，udp 头部字节是 8Byte）

  - IP 层自己的头部需要占 20 字节，所以 IP 层传输的数据最多是`MTU = 1500Byte - 20 = 1480Bytes`, 超过这个值就要被 IP 层分片发送，在达到目的前会自己重组

- `TCP 分组`

  - TCP 是可靠传输协议，通过超时与重传机制，来保证收到的数据是完整的

  - 如果要传输的数据大于`1480 - 20(tcp头部) = 1460Byte` 时，在网络层被分片，而如果其中某个分片丢失，因为 TCP 层层不知道哪个数据片丢失，所以就需要重传整个数据段，这样就造成了很大空间和时间资源的浪费

  - 为了解决这个问题，就有了 TCP 分组和 MSS（最长报文大小）概念，利用 tcp 三次握手建立链接的过程，交互各自的 MTU，`MSS = min(MTU) - 20 - 20`，这样就可以避免在 ip 层被分片

- `UDP`

  分组可以发生在运输层和网络层，运输层中的 TCP 会分段，网络层中的 IP 会分片。`IP 层的分片更多的是为运输层的 UDP 服务的`，由于 TCP 自己会避免 IP 的分片，所以使用 TCP 传输在 IP 层都不会发生分片的现象，所以就有了网上的 1500 - 20(ip 头部) - 8(udp 头部) > 1472 的说法，把 1472 作为 ip 分片的标准

# `IP` 数据报

## `IP` 报文结构

![alt](https://bkimg.cdn.bcebos.com/pic/c8177f3e6709c93d464442fd903df8dcd1005401?x-bce-process=image/watermark,image_d2F0ZXIvYmFpa2UxMTY=,g_7,xp_5,yp_5)

- [IP 数据报字段解析](https://blog.csdn.net/jiejiemcu/article/details/89072573)

  > 一个字节 `8` 位，图中一行为 `32` 位，即 `4` 个字节

- 固定部分为 `4 * 5 = 20` 个字节

- `0 - 4 位` 为版本号

  值为 `4` 表示是 `IPV4`，为 `6` 则表示是 `IPV6`

- `4 - 8 位` 为首部长度

  - 因为 IP 首部中包含了一些可变的数据选项（如果存在），故需要记录首部的长度，以便区分数据部分的起始位置

  - 首部长度一共才`4` 位，可是`IP` 报头最少都`20` 个字节了，对不上啊

    以`32 位（4个字节）为一个单位`（即图中一行的大小），那么这个字段长度为`4` 位，可表示的最大值为`1111 = 15`

  - 所以`首部长度`最大为`1111 * 4 = 15 * 4 = 60`字节，即，首部长度`4` 位填满；最小为`20` 字节，即`可变部分和数据部分` 都为`0`，所以首部长度的值最小为固定部分的 20 个字节，所以首部长度字段最小为`20/4 = 5 = 0101`

- `8 - 16 位` 为服务类型 `TOS`

  - 服务类型包含在`IPv4` 首部中，`以便使不同类型的 IP 数据报能区分开来`，例如，一些特别要求低时延、高吞吐量或可靠性的数据报，能相互区别开来。提供特定等级的服务是一个由路由器管理员决定的策略问题，简单来说就路由器根据是这个字段的值来为数据报提供（选择）最合理的路径。

  - 图中上部分，前`3` 位为优先级、接着为最小延迟`D`、最大吞吐量`T`、最高可靠性`R`、最小费用`F`，以及一位保留位

- `16 - 31 位` 总长度

  总共有 `16` 位，所以数据包的最大长度理论上为 `2^16 = 65535`，虽然允许那么大，但是由于底层链路硬件不允许那么大的数据报出现在链路上，所以最大也就是 `1500` 字节，再大一点就要做分片处理了

- 标识、标志与片偏移

  这三个字段和数据报分片有关

- `0 - 8 位` 生存时间 `TTL`

  - 记录的是跳数

  - 用来确保数据报不会长时间出现在网络中，（比如路由选择发生环路），每当数据报经过一台路由器，就会`把该值减一`，如果减少为 0 了，这个数据报就会被丢弃

  - 因为这个值一直会变，所以计算 `首部校验和` 的时候，不会把报头的这个字段计算进去

- `8 - 16 位`（上层）协议

  - 该字段仅在一个`IP` 数据报到达其最终目的地才会有用

  - 该字段的值指示了`IP` 数据报的数据部分应交给哪个传输层协议处理。例如，值为`6` 表明数据部分要交给 TCP，而值为`17` 表明数据要交给 UDP。如果没有它。将无法准确递交到层协议，`ICMP` 会返回一个协议不可达错误。

- `16 - 31 位` 首部校验和

  用来`保证数据报头部的数据完整性`，即不会去校验数据部分

- `32位` 的源地址、`32位`的目的地址

  所以 `ip` 地址的点分十进制为 `255.255.255.255`，对应起来就是 `32` 位

- 选项字段

  - 这个字段是为了对数据报首部做扩展

  - 就是用来自定义的，比如`VPN` 就是对报文动手脚，然后记录到这个选项字段中

- `数据部分`

  即整个数据报的有效载荷，前面都是在定规则，以下才是真正传输的数据部分

## `IP` 数据报校验和

- 为什么不校验数据部分呢

  - 因为对于网络层，他的数据部分是经过传输层封装后的数据信息，传输层里面已经包含整个数据的校验和了，让传输层做就行了

  - 而每次经过一个路由器，数据报的源地址、目的地址都会发生改变，但是数据部分是不变的，所以只要校验头部就行了

- 怎么做校验的呢

  ```sh
  # 使用的是网际校验和
  IP首部（不包含校验和）的反码 + 0的反码（0x1111) = 【发送端的校验和】
  IP首部 = IP首部（不包含校验和）+ 发送端的校验和

  IP首部（不包含校验和）的反码 + 发送端的校验和的反码 = 接收端校验和 (即：IP首部的反码)
  IP首部（不包含校验和）的反码 + （IP首部（不包含校验和）的反码 + 0的反码（0x1111)）的反码 = 接收端校验和

  IP首部（不包含校验和）的反码 + IP首部（不包含校验和）+ 0 = 【接收端校验和】

  经过校验和计算之后得到接收端校验和是全1的，当然即使是全1也不一定正常，但是不是全1肯定错误
  ```

## `IP` 地址分类

### 地址分类

- 首字节规则

  ![alt](https://images2018.cnblogs.com/blog/1440532/201809/1440532-20180912093201807-306001370.png)

- 地址范围

  | 分类   | 地址范围                          |
  | :----- | :-------------------------------- |
  | `A` 类 | `0.0.0.0 - 127.0.0.0`             |
  | `B` 类 | `128.0.0.1 - 191.255.255.255`     |
  | `C` 类 | `192.168.0.0 - 239.255.255.255.0` |

### 私有地址

> 没啥规律，都是规定

| 分类   | 私有地址范围                   |
| :----- | :----------------------------- |
| `A` 类 | `10.0.0.0～10.255.255.255`     |
| `B` 类 | `172.16.0.0～172.31.255.255`   |
| `C` 类 | `192.168.0.0～192.168.255.255` |
