- [协程](#协程)
  - [参考资料](#参考资料)
  - [★ 说一说协程和线程的区别](#-说一说协程和线程的区别)
  - [协程有哪些优缺点](#协程有哪些优缺点)
  - [协程是怎么切换的](#协程是怎么切换的)

# 协程

## 参考资料

## ★ 说一说协程和线程的区别

> - 线程的切换是由操作系统控制的，每次切换都涉及到 `上下文的保存切换`、`用户态与内核态之间的切换` 的过程
> - 协程的切换是由程序员自己控制的，每次切换 `只涉及到上下文的保存和切换`（即出栈入栈的过程）
> - 线程是 `抢占式` 的，协程是 `协作式` 的
> - 线程是操作系统调度，协程则是用户态调度

- 协程是`比线程更小`的执行单元。`拥有独立的寄存器、上下文、栈`

- 协程的`调度完全由用户控制`（也就是说是在用户态执行的，`不需要内核态用户态的切换`，所以比线程性能好）

- 多线程操作同一资源，涉及到 `等待、加锁、解锁` 的处理过程，而`因为同一线程上的所有协程是串行的`（线程是分配 cpu 的基本单位），某一时刻只会有一个协程在运行，所以不存在这样的问题）

- `执行效率高`

  因为子程序的切换不是线程切换，而是由程序自己去控制的，线程切换还会带来线程切换的开销，线程越多，劣势越明显

- 协程`不需要加锁`

  因为协程都是在一个线程内执行的，不存在写变量的冲突，协程中控制共享资源不加锁，只要判断号状态就行了

- 既然协程是在线程内部的调度单位，怎么发挥协程的威力（或者说怎么充分利用 CPU）

  `python` 因为 `GIL` 锁的存在，多线程对他来说没多大意义，所以可以使用 `进程` + `多协程` 来发挥多核 CPU 的作用

- 多线程开发，线程之间时无序的，协程之间执行按照一定的顺序交替执行

- 开辟一个协程大概需要 `5k` 的空间，开辟一个线程需要 `512k` 空间

- 不需要`锁`机制，因为只有一个线程，也不存在同时写变量导致的冲突，协程中控制共享资源不加锁，只要判断下状态就行，比线程效率高很多

## 协程有哪些优缺点

**优点**

- `无需线程上下文切换的开销`

- `无需原子操作锁定及同步的开销`

- 方便切换控制流，简化编程模型

- 高并发+高扩展性+低成本：一个 CPU 支持上万的协程都不是问题。所以很适合用于高并发处理。

**缺点**

- `无法利用多核资源`

  协程的本质是个单线程,它不能同时将单个 CPU 的多个核用上,协程需要和进程配合才能运行在多 CPU；

- `阻塞`操作（如 IO 时）会阻塞掉整个程序

  这一点和事件驱动一样，可以使用`异步 IO` 操作来解决。

- 一个线程可以有多个协程，用户创建了几个线程，然后每个线程都是循环按照指定的任务清单顺序完成不同的任务，当任务被堵塞的时候执行下一个任务，当恢复的时候再回来执行这个任务，`任务之间的切换只需要保存每个任务的上下文内容，就像直接操作栈一样的`，这样就完全`没有内核切换的开销，可以不加锁的访问全局变量，所以上下文的切换非常快`；另外协程还需要保证是非堵塞的且没有相互依赖，协程基本上不能同步通讯，多采用异步的消息通讯，效率比较高。

## 协程是怎么切换的

TODO
