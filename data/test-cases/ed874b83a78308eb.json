{"uid":"ed874b83a78308eb","name":"test_douyin_publish_app[image_article]","fullName":"lib.douyin.test_douyin_publish_app#test_douyin_publish_app","historyId":"0c7e7eb4a33479938cd675082087295c","time":{"start":1719584968093,"stop":1719585374383,"duration":406290},"description":"\n    测试图文发布、视频发布\n    ","descriptionHtml":"<pre><code>测试图文发布、视频发布\n</code></pre>\n","status":"broken","statusMessage":"mypy.lib.playwright.exceptions.PublishFail: RetryError[<Future at 0x7fc3f76ea430 state=finished raised PublishFail>]","statusTrace":"self = <mypy.lib.douyin.image_publish_helper.DouyinImagesPublishHelper object at 0x7fc3fc25de20>\nplaywright = <playwright._impl._playwright.Playwright object at 0x7fc3d8deb550>\n\n    async def publish_mission(self, playwright: Playwright):\n        \"\"\"\n        发布任务\n        \"\"\"\n        self._logger.info(\"=\" * 60)\n        self._logger.info('[%s] 开始执行发布任务', self.__class__.__name__)\n        self._logger.info(\"=\" * 60)\n    \n        # 浏览器上下文\n        browser, context, page = await PlaywrightCommon(\n            cookie_filepath=self._cookie_filepath,\n            headless=self._headless).launch_browser(playwright)\n        try:\n            # step1. 判断登录状态\n            await self._check_login_status(page)\n    \n            # step2. 上传发布内容\n>           await self.upload(page)\n\nmypy/lib/playwright/publish_helper.py:122: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \nmypy/lib/douyin/image_publish_helper.py:47: in upload\n    await super().upload(page, upload_url, upload_locator, upload_filepath)\nmypy/lib/douyin/publish_helper.py:348: in upload\n    raise ex\nmypy/lib/douyin/publish_helper.py:341: in upload\n    await page.click(upload_locator)\n/opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/playwright/_impl/_async_base.py:60: in __aexit__\n    await self._event.value\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nself = <playwright._impl._async_base.AsyncEventInfo object at 0x7fc3d8dbd220>\n\n    @property\n    async def value(self) -> T:\n>       return mapping.from_maybe_impl(await self._future)\nE       playwright._impl._errors.TimeoutError: Timeout 120000ms exceeded while waiting for event \"filechooser\"\nE       =========================== logs ===========================\nE       waiting for event \"filechooser\"\nE       ============================================================\n\n/opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/playwright/_impl/_async_base.py:35: TimeoutError\n\nThe above exception was the direct cause of the following exception:\n\nself = <mypy.lib.douyin.image_publish_helper.DouyinImagesPublishHelper object at 0x7fc3fc25de20>\n\n    async def do_publish(self):\n        \"\"\"\n        发布任务，如果获取登录状态失败，则重试\n        \"\"\"\n        try:\n            async for attempt in AsyncRetrying(\n                    stop=stop_after_attempt(LoginLocator.publish_retry_cnt),\n                    wait=wait_fixed(LoginLocator.publish_retry_interval),\n                    before_sleep=before_sleep_log(self._logger, logging.WARNING)):\n                with attempt:\n                    async with async_playwright() as playwright:\n>                       await self.publish_mission(playwright)\n\nmypy/lib/playwright/publish_helper.py:149: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nself = <mypy.lib.douyin.image_publish_helper.DouyinImagesPublishHelper object at 0x7fc3fc25de20>\nplaywright = <playwright._impl._playwright.Playwright object at 0x7fc3d8deb550>\n\n    async def publish_mission(self, playwright: Playwright):\n        \"\"\"\n        发布任务\n        \"\"\"\n        self._logger.info(\"=\" * 60)\n        self._logger.info('[%s] 开始执行发布任务', self.__class__.__name__)\n        self._logger.info(\"=\" * 60)\n    \n        # 浏览器上下文\n        browser, context, page = await PlaywrightCommon(\n            cookie_filepath=self._cookie_filepath,\n            headless=self._headless).launch_browser(playwright)\n        try:\n            # step1. 判断登录状态\n            await self._check_login_status(page)\n    \n            # step2. 上传发布内容\n            await self.upload(page)\n    \n            # step3. 填写信息\n            await self.fill_publish_content(page)\n    \n            # step4. 触发发布并检查是否发布成功\n            await self.publish_trigger(page)\n        except Exception as ex:\n            self._logger.exception('❌❌❌《%s》发布异常: %s',\n                                   self._pub_title, ex)\n>           raise PublishFail(original_exception=ex) from ex\nE           mypy.lib.playwright.exceptions.PublishFail: Timeout 120000ms exceeded while waiting for event \"filechooser\"\nE           =========================== logs ===========================\nE           waiting for event \"filechooser\"\nE           ============================================================\n\nmypy/lib/playwright/publish_helper.py:132: PublishFail\n\nThe above exception was the direct cause of the following exception:\n\nself = <mypy.lib.douyin.image_publish_helper.DouyinImagesPublishHelper object at 0x7fc3fc25de20>\n\n    async def do_publish(self):\n        \"\"\"\n        发布任务，如果获取登录状态失败，则重试\n        \"\"\"\n        try:\n>           async for attempt in AsyncRetrying(\n                    stop=stop_after_attempt(LoginLocator.publish_retry_cnt),\n                    wait=wait_fixed(LoginLocator.publish_retry_interval),\n                    before_sleep=before_sleep_log(self._logger, logging.WARNING)):\n\nmypy/lib/playwright/publish_helper.py:143: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n/opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/tenacity/asyncio/__init__.py:166: in __anext__\n    do = await self.iter(retry_state=self._retry_state)\n/opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/tenacity/asyncio/__init__.py:153: in iter\n    result = await action(retry_state)\n/opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/tenacity/_utils.py:99: in inner\n    return call(*args, **kwargs)\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nrs = <RetryCallState 140479134303424: attempt #3; slept for 6.0; last result: failed (PublishFail Timeout 120000ms exceeded...========================\nwaiting for event \"filechooser\"\n============================================================)>\n\n    def exc_check(rs: \"RetryCallState\") -> None:\n        fut = t.cast(Future, rs.outcome)\n        retry_exc = self.retry_error_cls(fut)\n        if self.reraise:\n            raise retry_exc.reraise()\n>       raise retry_exc from fut.exception()\nE       tenacity.RetryError: RetryError[<Future at 0x7fc3f76ea430 state=finished raised PublishFail>]\n\n/opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/tenacity/__init__.py:419: RetryError\n\nThe above exception was the direct cause of the following exception:\n\npublish_file = '/home/runner/work/github-runner/github-runner/mypy/assets/media/ppt/ppt_slide_images'\n\n    @pytest.mark.parametrize(\n        'publish_file',\n        [Assets.ppt_slide_image_dir, Assets.vertical_video, Assets.ppt_video_maked],\n        ids=[Const.MEDIA_TYPE_IMG_ARTICLE, 'vertical_video', 'ppt_video'])\n    def test_douyin_publish_app(publish_file):\n        \"\"\"\n        测试图文发布、视频发布\n        \"\"\"\n        media_type = Const.MEDIA_TYPE_VIDEO\n        if os.path.isdir(publish_file):\n            media_type = Const.MEDIA_TYPE_IMG_ARTICLE\n        set_publish_cfg(config_path=config_path,\n                        option='media_type',\n                        value=media_type)\n>       DouyinPublishApp(curr_dir).publish(\n            upload_filepath=publish_file)\n\nmypy/tests/lib/douyin/test_douyin_publish_app.py:60: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \nmypy/lib/playwright/publish_app.py:143: in publish\n    asyncio.run(\n/opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/asyncio/runners.py:44: in run\n    return loop.run_until_complete(main)\n/opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/asyncio/base_events.py:647: in run_until_complete\n    return future.result()\nmypy/lib/playwright/publish_app.py:139: in async_publish\n    await publish_helper.do_publish()\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nself = <mypy.lib.douyin.image_publish_helper.DouyinImagesPublishHelper object at 0x7fc3fc25de20>\n\n    async def do_publish(self):\n        \"\"\"\n        发布任务，如果获取登录状态失败，则重试\n        \"\"\"\n        try:\n            async for attempt in AsyncRetrying(\n                    stop=stop_after_attempt(LoginLocator.publish_retry_cnt),\n                    wait=wait_fixed(LoginLocator.publish_retry_interval),\n                    before_sleep=before_sleep_log(self._logger, logging.WARNING)):\n                with attempt:\n                    async with async_playwright() as playwright:\n                        await self.publish_mission(playwright)\n        except Exception as ex:\n            self._logger.exception('❌❌❌《%s》发布异常: %s',\n                                   self._pub_title, ex)\n>           raise PublishFail(original_exception=ex) from ex\nE           mypy.lib.playwright.exceptions.PublishFail: RetryError[<Future at 0x7fc3f76ea430 state=finished raised PublishFail>]\n\nmypy/lib/playwright/publish_helper.py:153: PublishFail","flaky":false,"newFailed":false,"newBroken":false,"newPassed":false,"retriesCount":0,"retriesStatusChange":false,"beforeStages":[{"name":"event_loop_policy","time":{"start":1719581870889,"stop":1719581870890,"duration":1},"status":"passed","steps":[],"attachments":[],"parameters":[],"shouldDisplayMessage":false,"stepsCount":0,"attachmentsCount":0,"hasContent":false,"attachmentStep":false},{"name":"copy_config_to_dir","time":{"start":1719584733819,"stop":1719584733820,"duration":1},"status":"passed","steps":[],"attachments":[],"parameters":[],"shouldDisplayMessage":false,"stepsCount":0,"attachmentsCount":0,"hasContent":false,"attachmentStep":false}],"testStage":{"description":"\n    测试图文发布、视频发布\n    ","status":"broken","statusMessage":"mypy.lib.playwright.exceptions.PublishFail: RetryError[<Future at 0x7fc3f76ea430 state=finished raised PublishFail>]","statusTrace":"self = <mypy.lib.douyin.image_publish_helper.DouyinImagesPublishHelper object at 0x7fc3fc25de20>\nplaywright = <playwright._impl._playwright.Playwright object at 0x7fc3d8deb550>\n\n    async def publish_mission(self, playwright: Playwright):\n        \"\"\"\n        发布任务\n        \"\"\"\n        self._logger.info(\"=\" * 60)\n        self._logger.info('[%s] 开始执行发布任务', self.__class__.__name__)\n        self._logger.info(\"=\" * 60)\n    \n        # 浏览器上下文\n        browser, context, page = await PlaywrightCommon(\n            cookie_filepath=self._cookie_filepath,\n            headless=self._headless).launch_browser(playwright)\n        try:\n            # step1. 判断登录状态\n            await self._check_login_status(page)\n    \n            # step2. 上传发布内容\n>           await self.upload(page)\n\nmypy/lib/playwright/publish_helper.py:122: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \nmypy/lib/douyin/image_publish_helper.py:47: in upload\n    await super().upload(page, upload_url, upload_locator, upload_filepath)\nmypy/lib/douyin/publish_helper.py:348: in upload\n    raise ex\nmypy/lib/douyin/publish_helper.py:341: in upload\n    await page.click(upload_locator)\n/opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/playwright/_impl/_async_base.py:60: in __aexit__\n    await self._event.value\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nself = <playwright._impl._async_base.AsyncEventInfo object at 0x7fc3d8dbd220>\n\n    @property\n    async def value(self) -> T:\n>       return mapping.from_maybe_impl(await self._future)\nE       playwright._impl._errors.TimeoutError: Timeout 120000ms exceeded while waiting for event \"filechooser\"\nE       =========================== logs ===========================\nE       waiting for event \"filechooser\"\nE       ============================================================\n\n/opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/playwright/_impl/_async_base.py:35: TimeoutError\n\nThe above exception was the direct cause of the following exception:\n\nself = <mypy.lib.douyin.image_publish_helper.DouyinImagesPublishHelper object at 0x7fc3fc25de20>\n\n    async def do_publish(self):\n        \"\"\"\n        发布任务，如果获取登录状态失败，则重试\n        \"\"\"\n        try:\n            async for attempt in AsyncRetrying(\n                    stop=stop_after_attempt(LoginLocator.publish_retry_cnt),\n                    wait=wait_fixed(LoginLocator.publish_retry_interval),\n                    before_sleep=before_sleep_log(self._logger, logging.WARNING)):\n                with attempt:\n                    async with async_playwright() as playwright:\n>                       await self.publish_mission(playwright)\n\nmypy/lib/playwright/publish_helper.py:149: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nself = <mypy.lib.douyin.image_publish_helper.DouyinImagesPublishHelper object at 0x7fc3fc25de20>\nplaywright = <playwright._impl._playwright.Playwright object at 0x7fc3d8deb550>\n\n    async def publish_mission(self, playwright: Playwright):\n        \"\"\"\n        发布任务\n        \"\"\"\n        self._logger.info(\"=\" * 60)\n        self._logger.info('[%s] 开始执行发布任务', self.__class__.__name__)\n        self._logger.info(\"=\" * 60)\n    \n        # 浏览器上下文\n        browser, context, page = await PlaywrightCommon(\n            cookie_filepath=self._cookie_filepath,\n            headless=self._headless).launch_browser(playwright)\n        try:\n            # step1. 判断登录状态\n            await self._check_login_status(page)\n    \n            # step2. 上传发布内容\n            await self.upload(page)\n    \n            # step3. 填写信息\n            await self.fill_publish_content(page)\n    \n            # step4. 触发发布并检查是否发布成功\n            await self.publish_trigger(page)\n        except Exception as ex:\n            self._logger.exception('❌❌❌《%s》发布异常: %s',\n                                   self._pub_title, ex)\n>           raise PublishFail(original_exception=ex) from ex\nE           mypy.lib.playwright.exceptions.PublishFail: Timeout 120000ms exceeded while waiting for event \"filechooser\"\nE           =========================== logs ===========================\nE           waiting for event \"filechooser\"\nE           ============================================================\n\nmypy/lib/playwright/publish_helper.py:132: PublishFail\n\nThe above exception was the direct cause of the following exception:\n\nself = <mypy.lib.douyin.image_publish_helper.DouyinImagesPublishHelper object at 0x7fc3fc25de20>\n\n    async def do_publish(self):\n        \"\"\"\n        发布任务，如果获取登录状态失败，则重试\n        \"\"\"\n        try:\n>           async for attempt in AsyncRetrying(\n                    stop=stop_after_attempt(LoginLocator.publish_retry_cnt),\n                    wait=wait_fixed(LoginLocator.publish_retry_interval),\n                    before_sleep=before_sleep_log(self._logger, logging.WARNING)):\n\nmypy/lib/playwright/publish_helper.py:143: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n/opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/tenacity/asyncio/__init__.py:166: in __anext__\n    do = await self.iter(retry_state=self._retry_state)\n/opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/tenacity/asyncio/__init__.py:153: in iter\n    result = await action(retry_state)\n/opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/tenacity/_utils.py:99: in inner\n    return call(*args, **kwargs)\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nrs = <RetryCallState 140479134303424: attempt #3; slept for 6.0; last result: failed (PublishFail Timeout 120000ms exceeded...========================\nwaiting for event \"filechooser\"\n============================================================)>\n\n    def exc_check(rs: \"RetryCallState\") -> None:\n        fut = t.cast(Future, rs.outcome)\n        retry_exc = self.retry_error_cls(fut)\n        if self.reraise:\n            raise retry_exc.reraise()\n>       raise retry_exc from fut.exception()\nE       tenacity.RetryError: RetryError[<Future at 0x7fc3f76ea430 state=finished raised PublishFail>]\n\n/opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/site-packages/tenacity/__init__.py:419: RetryError\n\nThe above exception was the direct cause of the following exception:\n\npublish_file = '/home/runner/work/github-runner/github-runner/mypy/assets/media/ppt/ppt_slide_images'\n\n    @pytest.mark.parametrize(\n        'publish_file',\n        [Assets.ppt_slide_image_dir, Assets.vertical_video, Assets.ppt_video_maked],\n        ids=[Const.MEDIA_TYPE_IMG_ARTICLE, 'vertical_video', 'ppt_video'])\n    def test_douyin_publish_app(publish_file):\n        \"\"\"\n        测试图文发布、视频发布\n        \"\"\"\n        media_type = Const.MEDIA_TYPE_VIDEO\n        if os.path.isdir(publish_file):\n            media_type = Const.MEDIA_TYPE_IMG_ARTICLE\n        set_publish_cfg(config_path=config_path,\n                        option='media_type',\n                        value=media_type)\n>       DouyinPublishApp(curr_dir).publish(\n            upload_filepath=publish_file)\n\nmypy/tests/lib/douyin/test_douyin_publish_app.py:60: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \nmypy/lib/playwright/publish_app.py:143: in publish\n    asyncio.run(\n/opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/asyncio/runners.py:44: in run\n    return loop.run_until_complete(main)\n/opt/hostedtoolcache/Python/3.9.19/x64/lib/python3.9/asyncio/base_events.py:647: in run_until_complete\n    return future.result()\nmypy/lib/playwright/publish_app.py:139: in async_publish\n    await publish_helper.do_publish()\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nself = <mypy.lib.douyin.image_publish_helper.DouyinImagesPublishHelper object at 0x7fc3fc25de20>\n\n    async def do_publish(self):\n        \"\"\"\n        发布任务，如果获取登录状态失败，则重试\n        \"\"\"\n        try:\n            async for attempt in AsyncRetrying(\n                    stop=stop_after_attempt(LoginLocator.publish_retry_cnt),\n                    wait=wait_fixed(LoginLocator.publish_retry_interval),\n                    before_sleep=before_sleep_log(self._logger, logging.WARNING)):\n                with attempt:\n                    async with async_playwright() as playwright:\n                        await self.publish_mission(playwright)\n        except Exception as ex:\n            self._logger.exception('❌❌❌《%s》发布异常: %s',\n                                   self._pub_title, ex)\n>           raise PublishFail(original_exception=ex) from ex\nE           mypy.lib.playwright.exceptions.PublishFail: RetryError[<Future at 0x7fc3f76ea430 state=finished raised PublishFail>]\n\nmypy/lib/playwright/publish_helper.py:153: PublishFail","steps":[],"attachments":[{"uid":"8e64235add1daf19","name":"log","source":"8e64235add1daf19.txt","type":"text/plain","size":15089}],"parameters":[],"shouldDisplayMessage":true,"stepsCount":0,"attachmentsCount":1,"hasContent":true,"attachmentStep":false},"afterStages":[{"name":"copy_config_to_dir::finish_callback","time":{"start":1719585447697,"stop":1719585447697,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"shouldDisplayMessage":false,"stepsCount":0,"attachmentsCount":0,"hasContent":false,"attachmentStep":false}],"labels":[{"name":"tag","value":"douyin"},{"name":"parentSuite","value":"lib.douyin"},{"name":"suite","value":"test_douyin_publish_app"},{"name":"host","value":"fv-az1788-68"},{"name":"thread","value":"7120-MainThread"},{"name":"framework","value":"pytest"},{"name":"language","value":"cpython3"},{"name":"package","value":"lib.douyin.test_douyin_publish_app"},{"name":"resultFormat","value":"allure2"}],"parameters":[{"name":"publish_file","value":"'/home/runner/work/github-runner/github-runner/mypy/assets/media/ppt/ppt_slide_images'"}],"links":[],"hidden":false,"retry":false,"extra":{"severity":"normal","retries":[],"categories":[{"name":"Test defects","matchedStatuses":[],"flaky":false}],"tags":["douyin"]},"source":"ed874b83a78308eb.json","parameterValues":["'/home/runner/work/github-runner/github-runner/mypy/assets/media/ppt/ppt_slide_images'"]}